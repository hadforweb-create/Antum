generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String      @id @default(cuid())
  email        String      @unique
  passwordHash String
  name         String?
  bio          String?
  avatarUrl    String?
  location     String?
  role         String      @default("FREELANCER")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  reels                    Reel[]
  skills                   UserSkill[]
  services                 Service[]
  shortlistedBy            Shortlist[]              @relation("ShortlistedUser")
  shortlists               Shortlist[]              @relation("ShortlistOwner")
  conversationParticipants ConversationParticipant[]
  messagesSent             Message[]
  
  // Security & Safety
  blockedUsers             Block[]                  @relation("Blocker")
  blockedBy                Block[]                  @relation("Blocked")
  reportsFiled             Report[]                 @relation("Reporter")
  reportsReceived          Report[]                 @relation("Reported")
}

model Reel {
  id        String   @id @default(cuid())
  userId    String
  caption   String?
  mediaUrl  String
  mediaType String   @default("IMAGE")
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Skill {
  id    String      @id @default(cuid())
  name  String      @unique
  users UserSkill[]
}

model UserSkill {
  userId  String
  skillId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([userId, skillId])
}

// ============================================
// MESSAGING MODELS
// ============================================

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]

  @@index([updatedAt])
}

model ConversationParticipant {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  text           String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
}

// ============================================
// SERVICE MARKETPLACE MODELS
// ============================================

model Service {
  id           String   @id @default(cuid())
  userId       String
  title        String
  description  String
  price        Int      // Price in cents
  currency     String   @default("USD")
  category     String
  deliveryDays Int      @default(7)
  imageUrl     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([isActive, createdAt])
}

// ============================================
// SHORTLIST/SAVED MODELS
// ============================================

model Shortlist {
  id        String   @id @default(cuid())
  userId    String   // The user who saved
  targetId  String   // The user/freelancer being saved
  createdAt DateTime @default(now())

  user   User @relation("ShortlistOwner", fields: [userId], references: [id], onDelete: Cascade)
  target User @relation("ShortlistedUser", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId])
  @@index([userId])
  @@index([targetId])
}

// ============================================
// SECURITY & SAFETY MODELS
// ============================================

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
}

model Report {
  id          String   @id @default(cuid())
  reporterId  String
  reportedId  String
  reason      String
  description String?
  status      String   @default("PENDING") // PENDING, REVIEWED, RESOLVED
  createdAt   DateTime @default(now())

  reporter    User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reported    User     @relation("Reported", fields: [reportedId], references: [id], onDelete: Cascade)

  @@index([reportedId])
  @@index([status])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}
